# Reproducing CVE-2024-34478

This example demonstrates how to reproduce
[CVE-2024-34478](https://delvingbitcoin.org/t/disclosure-btcd-consensus-bugs-due-to-usage-of-signed-transaction-version/455)
(a consensus bug in btcd) using SemSan.

## Build

In order to build this example you'll need to first build Bitcoin Core's
`libbitcoinconsensus` and `libsecp256k1` in two different configurations.

```
$ git clone https://github.com/bitcoin/bitcoin.git
$ pushd bitcoin
$ ./autogen.sh
$ mkdir build_aflpp && pushd build_aflpp
$ CC=afl-clang-lto CXX=afl-clang-lto++ ../configure && make -j$(nproc)
$ popd # build_aflpp
$ mkdir build_libfuzzer && pushd build_libfuzzer
$ CC=clang CXX=clang++ LDFLAGS="-fsanitize=fuzzer-no-link" ../configure && make -j$(nproc)
$ popd # build_libfuzzer
$ popd # bitcoin
$ cp ./bitcoin/build_aflpp/src/.libs/libbitcoinconsensus.a libbitcoinconsensus.a
$ cp ./bitcoin/build_aflpp/src/secp256k1/.libs/libsecp256k1.a libsecp256k1.a
$ cp ./bitcoin/build_libfuzzer/src/.libs/libbitcoinconsensus.a libbitcoinconsensus_libfuzzer.a
$ cp ./bitcoin/build_libfuzzer/src/secp256k1/.libs/libsecp256k1.a libsecp256k1_libfuzzer.a
```

To build the example itself simply invoke `make`.

## Fuzzing

SemSan itself is a not a very sofisticated fuzzer, it is therefore necessary to
combine SemSan with a second engine that excells at maximizing coverage. In
this example we combine SemSan with a libFuzzer instance.

First start the libFuzzer instance:

```
$ mkdir /tmp/libfuzzer_corpus
$ ./libbitcoinconsensus_harness_libfuzzer /tmp/libfuzzer_corpus
```

Then start SemSan and configure it to sync with the libfuzzer corpus.

```
$ # SemSan can't start from an empty seed corpus
$ mkdir /tmp/seeds && echo "AAA" > /tmp/seeds/A
$ # The fork server needs to be initialised before the Go runtime is initialised.
$ export AFL_EARLY_FORKSERVER=1
$ semsan --log-diff-values \
    --seeds /tmp/seeds --solutions /tmp/solutions \
    --foreign-corpus /tmp/libfuzzer_corpus \
    ./libbitcoinconsensus_harness ./btcd_harness
...
== ERROR: Semantic Difference
primary  : [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
secondary: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
...
```

To reproduce the solutions with more help logging, we can pass the solutions
directory as the seeds and use SemSan's `--debug-children` option to print the
harnesses' std{out,err}.

```
$ PRINT_ERROR=1 semsan --debug-children \
    --log-diff-values \
    --seeds /tmp/solutions --solutions /tmp/solutions \
    ./libbitcoinconsensus_harness ./btcd_harness
...
libbitcoinconsensus: verified=1 err=0
btcd: verified=0
btcd engine error: <nil>
btcd exec error: invalid transaction version: -1962934271
== ERROR: Semantic Difference
primary  : [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
secondary: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
...
```
