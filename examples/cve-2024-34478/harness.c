#include <assert.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/shm.h>
#include <unistd.h>

#ifdef USE_BITCOIN_CONSENSUS
#include <bitcoinconsensus.h>
#else
#include <libbtcdverifyscript.h>
#endif

static uint8_t unobserved_diff_value[32];
static uint8_t *diff_value = NULL;

struct split {
  const uint8_t *first;
  size_t first_len;
  const uint8_t *second;
  size_t second_len;
};

// Split `to_split` using "splitspk" as the delimiter
struct split split_bytes(const uint8_t *to_split, size_t to_split_len) {
  struct split s = {
      .first = NULL,
      .first_len = 0,
      .second = NULL,
      .second_len = 0,
  };
  const char seperator[8] = "splitspk";

  if (to_split_len < sizeof(seperator)) {
    return s;
  }

  for (int i = 0; (i + sizeof(seperator)) <= to_split_len; i++) {
    if (memcmp(to_split + i, seperator, sizeof(seperator)) == 0) {
      s.first = to_split;
      s.first_len = i;
      s.second = to_split + i + sizeof(seperator);
      s.second_len = to_split_len - s.first_len - sizeof(seperator);
      break;
    }
  }

  return s;
}

int LLVMFuzzerInitialize(int *argc, char ***argv) {
  const char *shmid = getenv("SEMSAN_CHARACTERIZATION_SHMEM_ID");
  if (shmid) {
    diff_value = (uint8_t *)shmat(atoi(shmid), NULL, 0);
  } else {
    diff_value = unobserved_diff_value;
  }

  assert(diff_value);
  memset(diff_value, 0, 32);
  return 0;
}

int LLVMFuzzerTestOneInput(const uint8_t *data, size_t size) {
  struct split input_split = split_bytes(data, size);
  if (!input_split.first) {
    return 0;
  }

  // Sanity check the split
  assert(input_split.first == data);
  assert(input_split.second >= data && input_split.second <= (data + size));
  assert((input_split.first_len + input_split.second_len) == (size - 8));

  const unsigned char *scriptPubKey = input_split.first;
  unsigned int scriptPubKeyLen = (int)input_split.first_len;
  const unsigned char *txTo = input_split.second;
  unsigned int txToLen = (int)input_split.second_len;
  unsigned int nIn = 0;

  // p2sh | der | nulldummy | checklocktimeverify | checksequenceverify |
  // witness
  int flags = (1 << 0) | (1 << 2) | (1 << 4) | (1 << 9) | (1 << 10) | (1 << 11);
#ifdef USE_BITCOIN_CONSENSUS
  bitcoinconsensus_error err;
  diff_value[0] = (uint8_t)bitcoinconsensus_verify_script_with_amount(
      scriptPubKey, scriptPubKeyLen, -1, txTo, txToLen, nIn, flags, &err);
  if (getenv("PRINT_ERROR")) {
    printf("libbitcoinconsensus: verified=%d err=%d\n", diff_value[0], err);
  }
#else
  diff_value[0] = (uint8_t)btcd_verify_script(
      (char *)scriptPubKey, scriptPubKeyLen, (char *)txTo, txToLen, nIn, flags);
  if (getenv("PRINT_ERROR")) {
    printf("btcd: verified=%d\n", diff_value[0]);
    btcd_print_errors();
  }
#endif
  return 0;
}
